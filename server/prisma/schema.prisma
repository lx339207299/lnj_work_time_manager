
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  phone     String   @unique
  name      String?
  password  String
  avatar    String?
  birthday  String?
  currentOrgId Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownedOrgs Organization[] @relation("OrgOwner")
  memberships OrganizationMember[]
  invitations Invitation[]
  currentOrg Organization? @relation("CurrentOrg", fields: [currentOrgId], references: [id])
}

model Organization {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  ownerId     Int
  owner       User     @relation("OrgOwner", fields: [ownerId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members     OrganizationMember[]
  projects    Project[]
  invitations Invitation[]
  users       User[]   @relation("CurrentOrg")
}

model OrganizationMember {
  id          Int      @id @default(autoincrement())
  orgId       Int
  organization Organization @relation(fields: [orgId], references: [id])
  
  userId      Int?
  user        User?    @relation(fields: [userId], references: [id])

  // Snapshot of employee info in this org
  name        String
  phone       String
  role        String   @default("member") // owner, leader, member, temp
  wageType    String   @default("day") // day, month, hour
  wageAmount  Float    @default(0)
  birthday    String?
  
  status      String   @default("active") // pending, active, disabled

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workRecords WorkRecord[]
  projectMemberships ProjectMember[]
  
  // Ensure unique phone per org? Or unique user per org.
  @@unique([orgId, userId])
}

model Project {
  id          Int      @id @default(autoincrement())
  orgId       Int
  organization Organization @relation(fields: [orgId], references: [id])
  
  name        String
  description String?
  status      String   @default("active") // active, completed
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workRecords WorkRecord[]
  projectMembers ProjectMember[]
  flows       ProjectFlow[]
}

model ProjectMember {
  id        Int      @id @default(autoincrement())
  projectId Int
  project   Project  @relation(fields: [projectId], references: [id])
  
  memberId  Int
  member    OrganizationMember @relation(fields: [memberId], references: [id])
  
  role      String   @default("member") // owner, member
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, memberId])
}

model ProjectFlow {
  id          Int      @id @default(autoincrement())
  projectId   Int
  project     Project  @relation(fields: [projectId], references: [id])
  
  type        String   // income, expense
  category    String   // 薪资, 收款, 福利, etc.
  amount      Float
  date        String   // YYYY-MM-DD
  remark      String?
  
  // Optional: link to a specific member if it's a salary payment
  relatedMemberId Int?
  // We can't easily link to OrgMember here if we want to keep it simple, but let's try
  // For now just store the name or ID if needed, or leave it decoupled
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WorkRecord {
  id          Int      @id @default(autoincrement())
  projectId   Int
  project     Project  @relation(fields: [projectId], references: [id])
  
  memberId    Int
  member      OrganizationMember @relation(fields: [memberId], references: [id])
  
  date        String // YYYY-MM-DD
  duration    Float
  content     String?
  
  // Snapshot of wage at the time of record
  wageSnapshot     Float
  wageTypeSnapshot String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Invitation {
  id        Int      @id @default(autoincrement())
  orgId     Int
  organization Organization @relation(fields: [orgId], references: [id])
  
  inviterId Int
  inviter   User     @relation(fields: [inviterId], references: [id])
  
  code      String   @unique
  status    String   @default("pending") // pending, accepted, expired
  expiresAt DateTime
  createdAt DateTime @default(now())
}
